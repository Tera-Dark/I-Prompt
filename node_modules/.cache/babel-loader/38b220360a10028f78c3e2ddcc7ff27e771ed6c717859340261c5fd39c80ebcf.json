{"ast":null,"code":"/**\n * ç®€åŒ–çš„å›¾åƒå…ƒæ•°æ®æå–å™¨\n * å‚è€ƒstable-diffusion-inspectorçš„å®ç°æ–¹å¼\n */\n\n// ä¸»è¦çš„æå–å‡½æ•°\nexport async function extractMetadata(file) {\n  console.log('ğŸš€ å¼€å§‹æå–å›¾åƒå…ƒæ•°æ®...');\n  const result = {\n    success: false,\n    filename: file.name,\n    extractedData: {},\n    standardizedData: null,\n    timestamp: new Date().toISOString()\n  };\n  try {\n    // åŸºæœ¬æ–‡ä»¶ä¿¡æ¯\n    result.basicInfo = {\n      size: file.size,\n      sizeFormatted: `${(file.size / 1024).toFixed(1)} KB`,\n      type: file.type,\n      lastModified: new Date(file.lastModified).toLocaleString()\n    };\n\n    // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©æå–æ–¹æ³•\n    if (file.type === 'image/png') {\n      const pngData = await extractFromPNG(file);\n      if (pngData) {\n        result.extractedData.PNG = pngData;\n      }\n    }\n\n    // å°è¯•EXIFæå–\n    try {\n      const exifData = await extractFromEXIF(file);\n      if (exifData) {\n        result.extractedData.EXIF = exifData;\n      }\n    } catch (error) {\n      console.warn('EXIFæå–å¤±è´¥:', error);\n    }\n\n    // æ ‡å‡†åŒ–æ•°æ®\n    result.standardizedData = standardizeData(result.extractedData);\n    result.success = Object.keys(result.extractedData).length > 0;\n\n    // æ·»åŠ æå–æ–¹æ³•ä¿¡æ¯\n    result.extractionMethods = Object.keys(result.extractedData).map(method => {\n      var _result$extractedData;\n      return {\n        method: method,\n        confidence: ((_result$extractedData = result.extractedData[method]) === null || _result$extractedData === void 0 ? void 0 : _result$extractedData.confidence) || 'unknown'\n      };\n    });\n    return result;\n  } catch (error) {\n    console.error('âŒ å…ƒæ•°æ®æå–å¤±è´¥:', error);\n    result.error = error.message;\n    throw error;\n  }\n}\n\n// PNGæ–‡ä»¶è§£æ - å‚è€ƒstable-diffusion-inspectorçš„ç®€æ´å®ç°\nasync function extractFromPNG(file) {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onload = e => {\n      try {\n        const buffer = e.target.result;\n        const chunks = parsePNGChunks(buffer);\n        const metadata = extractMetadataFromChunks(chunks);\n        resolve({\n          type: 'PNG',\n          confidence: metadata.confidence || 'medium',\n          data: metadata\n        });\n      } catch (error) {\n        console.warn('PNGè§£æå¤±è´¥:', error);\n        resolve(null);\n      }\n    };\n    reader.onerror = () => resolve(null);\n    reader.readAsArrayBuffer(file);\n  });\n}\n\n// ç®€åŒ–çš„PNGå—è§£æ\nfunction parsePNGChunks(buffer) {\n  const view = new DataView(buffer);\n  const chunks = [];\n  let offset = 8; // è·³è¿‡PNGç­¾å\n\n  // éªŒè¯PNGç­¾å\n  const signature = [0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A];\n  for (let i = 0; i < 8; i++) {\n    if (view.getUint8(i) !== signature[i]) {\n      throw new Error('ä¸æ˜¯æœ‰æ•ˆçš„PNGæ–‡ä»¶');\n    }\n  }\n  while (offset < buffer.byteLength - 8) {\n    try {\n      const length = view.getUint32(offset);\n      offset += 4;\n      const type = String.fromCharCode(view.getUint8(offset), view.getUint8(offset + 1), view.getUint8(offset + 2), view.getUint8(offset + 3));\n      offset += 4;\n      const data = new Uint8Array(buffer, offset, length);\n      offset += length;\n      const crc = view.getUint32(offset);\n      offset += 4;\n      chunks.push({\n        type,\n        length,\n        data,\n        crc\n      });\n      if (type === 'IEND') break;\n    } catch (error) {\n      console.warn('PNGå—è§£æè­¦å‘Š:', error);\n      break;\n    }\n  }\n  return chunks;\n}\n\n// ä»PNGå—æå–å…ƒæ•°æ®\nfunction extractMetadataFromChunks(chunks) {\n  const textChunks = chunks.filter(chunk => ['tEXt', 'iTXt', 'zTXt'].includes(chunk.type));\n  const metadata = {\n    confidence: 'low',\n    generationTool: 'Unknown',\n    positive: '',\n    negative: '',\n    parameters: {}\n  };\n  for (const chunk of textChunks) {\n    const textData = parseTextChunk(chunk);\n    if (!textData.keyword || !textData.text) continue;\n    console.log('è§£ææ–‡æœ¬å—:', textData.keyword, 'é•¿åº¦:', textData.text.length);\n\n    // æ£€æµ‹ä¸åŒæ ¼å¼\n    if (textData.keyword === 'parameters' && isAutomatic1111Format(textData.text)) {\n      const parsed = parseAutomatic1111(textData.text);\n      Object.assign(metadata, parsed);\n      metadata.generationTool = 'AUTOMATIC1111';\n      metadata.confidence = 'high';\n    } else if (['workflow', 'prompt'].includes(textData.keyword)) {\n      try {\n        const parsed = parseComfyUI(textData.text);\n        Object.assign(metadata, parsed);\n        metadata.generationTool = 'ComfyUI';\n        metadata.confidence = 'high';\n      } catch (error) {\n        console.warn('ComfyUIè§£æå¤±è´¥:', error);\n      }\n    } else if (['Description', 'Comment'].includes(textData.keyword)) {\n      try {\n        const parsed = parseNovelAI(textData.text);\n        Object.assign(metadata, parsed);\n        metadata.generationTool = 'NovelAI';\n        metadata.confidence = 'high';\n      } catch (error) {\n        console.warn('NovelAIè§£æå¤±è´¥:', error);\n      }\n    }\n  }\n  return metadata;\n}\n\n// è§£ææ–‡æœ¬å—\nfunction parseTextChunk(chunk) {\n  try {\n    const data = chunk.data;\n    if (chunk.type === 'tEXt') {\n      const nullIndex = data.indexOf(0);\n      if (nullIndex === -1) return {};\n      const keyword = decodeLatin1(data.slice(0, nullIndex));\n      const text = decodeLatin1(data.slice(nullIndex + 1));\n      return {\n        keyword,\n        text\n      };\n    }\n    if (chunk.type === 'iTXt') {\n      const nullIndices = [];\n      for (let i = 0; i < data.length; i++) {\n        if (data[i] === 0) {\n          nullIndices.push(i);\n          if (nullIndices.length >= 4) break;\n        }\n      }\n      if (nullIndices.length < 4) return {};\n      const keyword = decodeUTF8(data.slice(0, nullIndices[0]));\n      const text = decodeUTF8(data.slice(nullIndices[3] + 1));\n      return {\n        keyword,\n        text\n      };\n    }\n    return {};\n  } catch (error) {\n    console.warn('æ–‡æœ¬å—è§£æå¤±è´¥:', error);\n    return {};\n  }\n}\n\n// å®‰å…¨çš„å­—ç¬¦è§£ç \nfunction decodeLatin1(data) {\n  let result = '';\n  for (let i = 0; i < data.length; i++) {\n    result += String.fromCharCode(data[i]);\n  }\n  return result;\n}\nfunction decodeUTF8(data) {\n  try {\n    return new TextDecoder('utf-8', {\n      fatal: false\n    }).decode(data);\n  } catch (error) {\n    return decodeLatin1(data);\n  }\n}\n\n// æ£€æµ‹AUTOMATIC1111æ ¼å¼\nfunction isAutomatic1111Format(text) {\n  const lowerText = text.toLowerCase();\n  return lowerText.includes('steps:') || lowerText.includes('cfg scale:') || lowerText.includes('sampler:') || lowerText.includes('negative prompt:');\n}\n\n// è§£æAUTOMATIC1111æ•°æ®\nfunction parseAutomatic1111(text) {\n  const result = {\n    positive: '',\n    negative: '',\n    parameters: {}\n  };\n  try {\n    const negativeIndex = text.indexOf('Negative prompt:');\n    if (negativeIndex !== -1) {\n      result.positive = text.substring(0, negativeIndex).trim();\n      const afterNegative = text.substring(negativeIndex + 16);\n      const lines = afterNegative.split('\\n');\n      let negativePrompt = '';\n      let parameterLines = [];\n      let foundParams = false;\n      for (const line of lines) {\n        const trimmed = line.trim();\n        if (isParameterLine(trimmed)) {\n          foundParams = true;\n          parameterLines.push(trimmed);\n        } else if (!foundParams && trimmed) {\n          negativePrompt += (negativePrompt ? '\\n' : '') + trimmed;\n        } else if (foundParams) {\n          parameterLines.push(trimmed);\n        }\n      }\n      result.negative = negativePrompt.trim();\n      if (parameterLines.length > 0) {\n        result.parameters = parseParameters(parameterLines.join(', '));\n      }\n    } else {\n      // æ²¡æœ‰è´Ÿå‘æç¤ºè¯çš„æƒ…å†µ\n      const lines = text.split('\\n');\n      let positiveLines = [];\n      let parameterLines = [];\n      let foundParams = false;\n      for (const line of lines) {\n        const trimmed = line.trim();\n        if (isParameterLine(trimmed)) {\n          foundParams = true;\n          parameterLines.push(trimmed);\n        } else if (!foundParams && trimmed) {\n          positiveLines.push(trimmed);\n        } else if (foundParams) {\n          parameterLines.push(trimmed);\n        }\n      }\n      result.positive = positiveLines.join(' ').trim();\n      if (parameterLines.length > 0) {\n        result.parameters = parseParameters(parameterLines.join(', '));\n      }\n    }\n  } catch (error) {\n    console.warn('AUTOMATIC1111è§£æè­¦å‘Š:', error);\n    result.positive = text;\n  }\n  return result;\n}\n\n// æ£€æµ‹å‚æ•°è¡Œ\nfunction isParameterLine(line) {\n  return /\\b(Steps|Sampler|CFG scale|Seed|Size|Model):/i.test(line);\n}\n\n// è§£æå‚æ•°\nfunction parseParameters(paramText) {\n  const parameters = {};\n  const regex = /(\\w+(?:\\s+\\w+)*)\\s*:\\s*([^,]+?)(?=,\\s*\\w+\\s*:|$)/g;\n  let match;\n  while ((match = regex.exec(paramText)) !== null) {\n    const key = match[1].trim().toLowerCase().replace(/\\s+/g, '');\n    const value = match[2].trim();\n    const numValue = parseFloat(value);\n    parameters[key] = !isNaN(numValue) && isFinite(numValue) ? numValue : value;\n  }\n  return parameters;\n}\n\n// è§£æComfyUIæ•°æ®\nfunction parseComfyUI(text) {\n  const result = {\n    positive: '',\n    negative: '',\n    parameters: {}\n  };\n  try {\n    const data = JSON.parse(text);\n    if (Array.isArray(data === null || data === void 0 ? void 0 : data.nodes)) {\n      // å·¥ä½œæµæ ¼å¼\n      console.log('ğŸ“‹ æ£€æµ‹åˆ°ComfyUIå·¥ä½œæµæ ¼å¼');\n      const prompts = extractFromComfyWorkflow(data);\n      result.positive = prompts.positive;\n      result.negative = prompts.negative;\n      Object.assign(result.parameters, prompts.parameters);\n    } else if (typeof data === 'object') {\n      // æç¤ºæ ¼å¼\n      console.log('ğŸ“‹ æ£€æµ‹åˆ°ComfyUIæç¤ºæ ¼å¼');\n      const prompts = extractFromComfyPrompt(data);\n      result.positive = prompts.positive;\n      result.negative = prompts.negative;\n      Object.assign(result.parameters, prompts.parameters);\n    }\n\n    // å¦‚æœæ²¡æœ‰æå–åˆ°æç¤ºè¯ï¼Œå°è¯•æ·±åº¦æœç´¢\n    if (!result.positive && !result.negative) {\n      console.log('ğŸ” å¼€å§‹æ·±åº¦æœç´¢æç¤ºè¯...');\n      const deepSearch = deepSearchPrompts(data);\n      result.positive = deepSearch.positive;\n      result.negative = deepSearch.negative;\n      Object.assign(result.parameters, deepSearch.parameters);\n    }\n  } catch (error) {\n    console.warn('ComfyUIè§£æå¤±è´¥:', error);\n  }\n  return result;\n}\n\n// æ·±åº¦æœç´¢æç¤ºè¯ï¼ˆç”¨äºå¤æ‚å·¥ä½œæµï¼‰\nfunction deepSearchPrompts(data) {\n  const result = {\n    positive: '',\n    negative: '',\n    parameters: {}\n  };\n  const allTexts = [];\n\n  // é€’å½’æœç´¢æ‰€æœ‰å¯èƒ½åŒ…å«æ–‡æœ¬çš„å­—æ®µ\n  function searchObject(obj, path = '') {\n    if (typeof obj === 'string' && obj.trim().length > 10) {\n      // è¿‡æ»¤æ‰æ˜æ˜¾ä¸æ˜¯æç¤ºè¯çš„æ–‡æœ¬\n      if (!isSystemText(obj)) {\n        allTexts.push({\n          text: obj.trim(),\n          path: path,\n          length: obj.trim().length\n        });\n        console.log(`ğŸ” å‘ç°æ–‡æœ¬ (${path}): ${obj.substring(0, 50)}...`);\n      }\n    } else if (Array.isArray(obj)) {\n      obj.forEach((item, index) => {\n        searchObject(item, `${path}[${index}]`);\n      });\n    } else if (typeof obj === 'object' && obj !== null) {\n      Object.entries(obj).forEach(([key, value]) => {\n        // é‡ç‚¹å…³æ³¨å¯èƒ½åŒ…å«æç¤ºè¯çš„å­—æ®µ\n        const importantKeys = ['text', 'prompt', 'string', 'content', 'value', 'input', 'output'];\n        const newPath = importantKeys.includes(key.toLowerCase()) ? `${path}.${key}*` : `${path}.${key}`;\n        searchObject(value, newPath);\n      });\n    }\n  }\n  searchObject(data);\n\n  // æŒ‰é•¿åº¦æ’åºï¼Œä¼˜å…ˆå¤„ç†è¾ƒé•¿çš„æ–‡æœ¬ï¼ˆå¯èƒ½æ˜¯æœ€ç»ˆç»“æœï¼‰\n  allTexts.sort((a, b) => b.length - a.length);\n  console.log(`ğŸ¯ å…±å‘ç° ${allTexts.length} ä¸ªæ–‡æœ¬ç‰‡æ®µ`);\n\n  // æ™ºèƒ½åˆ†ç±»æ–‡æœ¬\n  const positiveTexts = [];\n  const negativeTexts = [];\n  for (const textObj of allTexts) {\n    const text = textObj.text;\n\n    // è·³è¿‡é‡å¤çš„æ–‡æœ¬\n    if (positiveTexts.some(t => t.includes(text) || text.includes(t)) || negativeTexts.some(t => t.includes(text) || text.includes(t))) {\n      continue;\n    }\n    if (isNegativePrompt(text)) {\n      negativeTexts.push(text);\n      console.log(`â– åˆ†ç±»ä¸ºè´Ÿå‘: ${text.substring(0, 30)}...`);\n    } else {\n      positiveTexts.push(text);\n      console.log(`â• åˆ†ç±»ä¸ºæ­£å‘: ${text.substring(0, 30)}...`);\n    }\n  }\n\n  // é€‰æ‹©æœ€ä½³æ–‡æœ¬\n  result.positive = selectBestPrompt(positiveTexts);\n  result.negative = selectBestPrompt(negativeTexts);\n  return result;\n}\n\n// åˆ¤æ–­æ˜¯å¦ä¸ºç³»ç»Ÿæ–‡æœ¬ï¼ˆéæç¤ºè¯ï¼‰\nfunction isSystemText(text) {\n  const systemPatterns = [/^[a-f0-9]{8,}$/i,\n  // å“ˆå¸Œå€¼\n  /^\\d+\\.\\d+\\.\\d+/,\n  // ç‰ˆæœ¬å·\n  /^https?:\\/\\//,\n  // URL\n  /^[A-Z_]+$/,\n  // å…¨å¤§å†™å¸¸é‡\n  /^\\w+\\.(png|jpg|jpeg|webp|gif)$/i,\n  // æ–‡ä»¶å\n  /^(true|false|null|undefined)$/i,\n  // å¸ƒå°”å€¼\n  /^\\d+x\\d+$/,\n  // å°ºå¯¸\n  /^#[a-f0-9]{6}$/i // é¢œè‰²ä»£ç \n  ];\n  return systemPatterns.some(pattern => pattern.test(text.trim()));\n}\n\n// é€‰æ‹©æœ€ä½³æç¤ºè¯\nfunction selectBestPrompt(texts) {\n  if (texts.length === 0) return '';\n  if (texts.length === 1) return texts[0];\n\n  // è¯„åˆ†ç³»ç»Ÿ\n  const scoredTexts = texts.map(text => {\n    let score = 0;\n\n    // é•¿åº¦åŠ åˆ†ï¼ˆä½†ä¸æ˜¯è¶Šé•¿è¶Šå¥½ï¼‰\n    const idealLength = 200;\n    const lengthScore = Math.max(0, 1 - Math.abs(text.length - idealLength) / idealLength);\n    score += lengthScore * 0.3;\n\n    // é€—å·æ•°é‡åŠ åˆ†ï¼ˆè¡¨ç¤ºæ ‡ç­¾ä¸°å¯Œåº¦ï¼‰\n    const commaCount = (text.match(/,/g) || []).length;\n    score += Math.min(commaCount / 10, 1) * 0.2;\n\n    // åŒ…å«è´¨é‡è¯åŠ åˆ†\n    const qualityWords = ['masterpiece', 'best quality', 'high quality', 'detailed', 'professional'];\n    const qualityScore = qualityWords.filter(word => text.toLowerCase().includes(word)).length / qualityWords.length;\n    score += qualityScore * 0.2;\n\n    // åŒ…å«è‰ºæœ¯é£æ ¼è¯åŠ åˆ†\n    const styleWords = ['anime', 'realistic', 'painting', 'illustration', 'digital art', 'concept art'];\n    const styleScore = styleWords.filter(word => text.toLowerCase().includes(word)).length / styleWords.length;\n    score += styleScore * 0.1;\n\n    // é¿å…é‡å¤è¯æ±‡\n    const words = text.toLowerCase().split(/\\s+/);\n    const uniqueWords = new Set(words);\n    const uniqueRatio = uniqueWords.size / words.length;\n    score += uniqueRatio * 0.2;\n    return {\n      text,\n      score\n    };\n  });\n\n  // é€‰æ‹©å¾—åˆ†æœ€é«˜çš„\n  scoredTexts.sort((a, b) => b.score - a.score);\n  const best = scoredTexts[0];\n  console.log(`ğŸ† é€‰æ‹©æœ€ä½³æç¤ºè¯ (å¾—åˆ†: ${best.score.toFixed(2)}): ${best.text.substring(0, 50)}...`);\n  return best.text;\n}\n\n// ä»ComfyUIå·¥ä½œæµæå–\nfunction extractFromComfyWorkflow(workflow) {\n  var _workflow$nodes;\n  const positivePrompts = [];\n  const negativePrompts = [];\n  const parameters = {};\n  console.log('ğŸ” åˆ†æComfyUIå·¥ä½œæµï¼ŒèŠ‚ç‚¹æ•°é‡:', ((_workflow$nodes = workflow.nodes) === null || _workflow$nodes === void 0 ? void 0 : _workflow$nodes.length) || 0);\n  for (const node of workflow.nodes || []) {\n    console.log(`ğŸ“ æ£€æŸ¥èŠ‚ç‚¹: ${node.type} (${node.title || 'untitled'})`);\n\n    // æ‰©å±•æ”¯æŒçš„æ–‡æœ¬ç¼–ç èŠ‚ç‚¹ç±»å‹\n    const textEncoderTypes = ['CLIPTextEncode', 'CLIPTextEncodeSDXL', 'BNK_CLIPTextEncoder',\n    // BNKç³»åˆ—èŠ‚ç‚¹\n    'WeiLin-ComfyUI-prompt-all-in-one',\n    // WeiLinæ’ä»¶\n    'TIPO',\n    // TIPOèŠ‚ç‚¹\n    'PromptWithStyle',\n    // æ ·å¼æç¤ºè¯èŠ‚ç‚¹\n    'StringFunction',\n    // å­—ç¬¦ä¸²å¤„ç†èŠ‚ç‚¹\n    'Text',\n    // é€šç”¨æ–‡æœ¬èŠ‚ç‚¹\n    'TextInput',\n    // æ–‡æœ¬è¾“å…¥èŠ‚ç‚¹\n    'PromptBuilder',\n    // æç¤ºè¯æ„å»ºå™¨\n    'AdvancedCLIPTextEncode',\n    // é«˜çº§CLIPç¼–ç å™¨\n    'CLIPTextEncodeFlux',\n    // Fluxæ¨¡å‹ç¼–ç å™¨\n    'ShowText',\n    // æ˜¾ç¤ºæ–‡æœ¬èŠ‚ç‚¹\n    'StringConstant',\n    // å­—ç¬¦ä¸²å¸¸é‡\n    'MultilineStringLiteral' // å¤šè¡Œå­—ç¬¦ä¸²\n    ];\n    if (textEncoderTypes.includes(node.type)) {\n      console.log(`âœ… æ‰¾åˆ°æ–‡æœ¬ç¼–ç èŠ‚ç‚¹: ${node.type}`);\n\n      // å°è¯•å¤šç§æ–¹å¼è·å–æ–‡æœ¬å†…å®¹\n      let text = null;\n\n      // æ–¹å¼1: widgets_valuesæ•°ç»„\n      if (node.widgets_values && Array.isArray(node.widgets_values)) {\n        for (const value of node.widgets_values) {\n          if (typeof value === 'string' && value.trim().length > 0) {\n            text = value.trim();\n            console.log(`ğŸ“„ ä»widgets_valuesè·å–æ–‡æœ¬: ${text.substring(0, 50)}...`);\n            break;\n          }\n        }\n      }\n\n      // æ–¹å¼2: ç›´æ¥çš„textå±æ€§\n      if (!text && node.text && typeof node.text === 'string') {\n        text = node.text.trim();\n        console.log(`ğŸ“„ ä»textå±æ€§è·å–æ–‡æœ¬: ${text.substring(0, 50)}...`);\n      }\n\n      // æ–¹å¼3: inputsä¸­çš„text\n      if (!text && node.inputs) {\n        for (const input of node.inputs) {\n          if (input.name === 'text' && input.widget && input.widget.value) {\n            text = input.widget.value.trim();\n            console.log(`ğŸ“„ ä»inputsè·å–æ–‡æœ¬: ${text.substring(0, 50)}...`);\n            break;\n          }\n        }\n      }\n\n      // æ–¹å¼4: propertiesä¸­æŸ¥æ‰¾\n      if (!text && node.properties) {\n        if (node.properties.text) {\n          text = node.properties.text.trim();\n          console.log(`ğŸ“„ ä»propertiesè·å–æ–‡æœ¬: ${text.substring(0, 50)}...`);\n        }\n      }\n      if (text && text.length > 0) {\n        var _node$title, _node$title2, _node$title3;\n        // æ™ºèƒ½åˆ¤æ–­æ˜¯å¦ä¸ºè´Ÿå‘æç¤ºè¯\n        const isNegative = isNegativePrompt(text) || ((_node$title = node.title) === null || _node$title === void 0 ? void 0 : _node$title.toLowerCase().includes('negative')) || ((_node$title2 = node.title) === null || _node$title2 === void 0 ? void 0 : _node$title2.toLowerCase().includes('è´Ÿå‘')) || ((_node$title3 = node.title) === null || _node$title3 === void 0 ? void 0 : _node$title3.toLowerCase().includes('åå‘')) || node.color && (node.color === '#ff6b6b' || node.color === '#e74c3c'); // çº¢è‰²é€šå¸¸è¡¨ç¤ºè´Ÿå‘\n\n        if (isNegative) {\n          negativePrompts.push(text);\n          console.log(`â– è¯†åˆ«ä¸ºè´Ÿå‘æç¤ºè¯: ${text.substring(0, 30)}...`);\n        } else {\n          positivePrompts.push(text);\n          console.log(`â• è¯†åˆ«ä¸ºæ­£å‘æç¤ºè¯: ${text.substring(0, 30)}...`);\n        }\n      }\n    }\n\n    // æå–é‡‡æ ·å™¨å‚æ•°\n    if (['KSampler', 'KSamplerAdvanced', 'SamplerCustom'].includes(node.type)) {\n      if (node.widgets_values) {\n        const [seed, steps, cfg, sampler_name, scheduler, denoise] = node.widgets_values;\n        if (seed !== undefined) parameters.seed = seed;\n        if (steps !== undefined) parameters.steps = steps;\n        if (cfg !== undefined) parameters.cfg_scale = cfg;\n        if (sampler_name !== undefined) parameters.sampler = sampler_name;\n        if (scheduler !== undefined) parameters.scheduler = scheduler;\n        if (denoise !== undefined) parameters.denoise = denoise;\n        console.log(`âš™ï¸ æå–é‡‡æ ·å™¨å‚æ•°: steps=${steps}, cfg=${cfg}, sampler=${sampler_name}`);\n      }\n    }\n\n    // æå–æ¨¡å‹ä¿¡æ¯\n    if (['CheckpointLoaderSimple', 'CheckpointLoader'].includes(node.type)) {\n      if (node.widgets_values && node.widgets_values[0]) {\n        parameters.model = node.widgets_values[0];\n        console.log(`ğŸ¯ æå–æ¨¡å‹: ${parameters.model}`);\n      }\n    }\n\n    // æå–å›¾åƒå°ºå¯¸\n    if (['EmptyLatentImage', 'LatentUpscale'].includes(node.type)) {\n      if (node.widgets_values) {\n        const [width, height] = node.widgets_values;\n        if (width !== undefined) parameters.width = width;\n        if (height !== undefined) parameters.height = height;\n        console.log(`ğŸ“ æå–å°ºå¯¸: ${width}x${height}`);\n      }\n    }\n  }\n\n  // æ™ºèƒ½åˆå¹¶æç¤ºè¯\n  const finalPositive = smartMergePrompts(positivePrompts);\n  const finalNegative = smartMergePrompts(negativePrompts);\n  console.log(`ğŸ¯ æœ€ç»ˆç»“æœ: æ­£å‘æç¤ºè¯${finalPositive.length}å­—ç¬¦, è´Ÿå‘æç¤ºè¯${finalNegative.length}å­—ç¬¦`);\n  return {\n    positive: finalPositive,\n    negative: finalNegative,\n    parameters\n  };\n}\n\n// æ™ºèƒ½åˆå¹¶æç¤ºè¯\nfunction smartMergePrompts(prompts) {\n  if (prompts.length === 0) return '';\n  if (prompts.length === 1) return prompts[0];\n\n  // å»é‡å¹¶æŒ‰é•¿åº¦æ’åºï¼Œä¼˜å…ˆé€‰æ‹©æ›´å®Œæ•´çš„æç¤ºè¯\n  const uniquePrompts = [...new Set(prompts)];\n  uniquePrompts.sort((a, b) => b.length - a.length);\n\n  // å¦‚æœæœ€é•¿çš„æç¤ºè¯æ˜æ˜¾æ¯”å…¶ä»–çš„é•¿å¾ˆå¤šï¼Œå¯èƒ½æ˜¯æœ€ç»ˆåˆæˆçš„ç»“æœ\n  const longest = uniquePrompts[0];\n  const secondLongest = uniquePrompts[1] || '';\n  if (longest.length > secondLongest.length * 2) {\n    console.log(`ğŸ¯ é€‰æ‹©æœ€é•¿æç¤ºè¯ä½œä¸ºæœ€ç»ˆç»“æœ: ${longest.length} vs ${secondLongest.length}`);\n    return longest;\n  }\n\n  // å¦åˆ™åˆå¹¶æ‰€æœ‰å”¯ä¸€çš„æç¤ºè¯\n  return uniquePrompts.join(', ');\n}\n\n// ä»ComfyUIæç¤ºæå–\nfunction extractFromComfyPrompt(prompt) {\n  const positivePrompts = [];\n  const negativePrompts = [];\n  const parameters = {};\n  console.log('ğŸ” åˆ†æComfyUIæç¤ºæ ¼å¼ï¼ŒèŠ‚ç‚¹æ•°é‡:', Object.keys(prompt).length);\n  for (const [nodeId, nodeData] of Object.entries(prompt)) {\n    console.log(`ğŸ“ æ£€æŸ¥èŠ‚ç‚¹ ${nodeId}: ${nodeData.class_type}`);\n\n    // æ‰©å±•æ”¯æŒçš„èŠ‚ç‚¹ç±»å‹\n    const textEncoderTypes = ['CLIPTextEncode', 'CLIPTextEncodeSDXL', 'BNK_CLIPTextEncoder', 'WeiLin-ComfyUI-prompt-all-in-one', 'TIPO', 'PromptWithStyle', 'StringFunction', 'Text', 'TextInput', 'PromptBuilder', 'AdvancedCLIPTextEncode', 'CLIPTextEncodeFlux', 'ShowText', 'StringConstant', 'MultilineStringLiteral'];\n    if (textEncoderTypes.includes(nodeData.class_type)) {\n      var _nodeData$inputs, _nodeData$inputs2, _nodeData$inputs3;\n      console.log(`âœ… æ‰¾åˆ°æ–‡æœ¬ç¼–ç èŠ‚ç‚¹: ${nodeData.class_type}`);\n\n      // å°è¯•å¤šç§æ–¹å¼è·å–æ–‡æœ¬\n      let text = null;\n      if ((_nodeData$inputs = nodeData.inputs) !== null && _nodeData$inputs !== void 0 && _nodeData$inputs.text && typeof nodeData.inputs.text === 'string') {\n        text = nodeData.inputs.text.trim();\n        console.log(`ğŸ“„ ä»inputs.textè·å–: ${text.substring(0, 50)}...`);\n      } else if ((_nodeData$inputs2 = nodeData.inputs) !== null && _nodeData$inputs2 !== void 0 && _nodeData$inputs2.prompt && typeof nodeData.inputs.prompt === 'string') {\n        text = nodeData.inputs.prompt.trim();\n        console.log(`ğŸ“„ ä»inputs.promptè·å–: ${text.substring(0, 50)}...`);\n      } else if ((_nodeData$inputs3 = nodeData.inputs) !== null && _nodeData$inputs3 !== void 0 && _nodeData$inputs3.string && typeof nodeData.inputs.string === 'string') {\n        text = nodeData.inputs.string.trim();\n        console.log(`ğŸ“„ ä»inputs.stringè·å–: ${text.substring(0, 50)}...`);\n      }\n      if (text && text.length > 0) {\n        if (isNegativePrompt(text)) {\n          negativePrompts.push(text);\n          console.log(`â– è¯†åˆ«ä¸ºè´Ÿå‘æç¤ºè¯`);\n        } else {\n          positivePrompts.push(text);\n          console.log(`â• è¯†åˆ«ä¸ºæ­£å‘æç¤ºè¯`);\n        }\n      }\n    }\n\n    // æå–å…¶ä»–å‚æ•°...\n    if (['KSampler', 'KSamplerAdvanced', 'SamplerCustom'].includes(nodeData.class_type)) {\n      const inputs = nodeData.inputs;\n      if (inputs.seed !== undefined) parameters.seed = inputs.seed;\n      if (inputs.steps !== undefined) parameters.steps = inputs.steps;\n      if (inputs.cfg !== undefined) parameters.cfg_scale = inputs.cfg;\n      if (inputs.sampler_name !== undefined) parameters.sampler = inputs.sampler_name;\n      if (inputs.scheduler !== undefined) parameters.scheduler = inputs.scheduler;\n      if (inputs.denoise !== undefined) parameters.denoise = inputs.denoise;\n    }\n  }\n  const finalPositive = smartMergePrompts(positivePrompts);\n  const finalNegative = smartMergePrompts(negativePrompts);\n  console.log(`ğŸ¯ æœ€ç»ˆç»“æœ: æ­£å‘æç¤ºè¯${finalPositive.length}å­—ç¬¦, è´Ÿå‘æç¤ºè¯${finalNegative.length}å­—ç¬¦`);\n  return {\n    positive: finalPositive,\n    negative: finalNegative,\n    parameters\n  };\n}\n\n// æ£€æµ‹è´Ÿå‘æç¤ºè¯\nfunction isNegativePrompt(text) {\n  const lowerText = text.toLowerCase();\n\n  // æ‰©å±•è´Ÿå‘å…³é”®è¯åˆ—è¡¨\n  const negativeKeywords = [\n  // è´¨é‡ç›¸å…³\n  'worst quality', 'bad quality', 'low quality', 'poor quality', 'bad anatomy', 'bad proportions', 'bad hands', 'bad fingers', 'ugly', 'deformed', 'disfigured', 'mutated', 'malformed', 'blurry', 'blur', 'out of focus', 'unfocused', 'soft focus', 'lowres', 'low resolution', 'pixelated', 'jpeg artifacts',\n  // æŠ€æœ¯é—®é¢˜\n  'error', 'glitch', 'artifact', 'noise', 'grain', 'distorted', 'cropped', 'cut off', 'truncated', 'incomplete', 'watermark', 'signature', 'text', 'logo', 'username', 'border', 'frame', 'black bars', 'letterbox',\n  // è§£å‰–é—®é¢˜\n  'extra limbs', 'missing limbs', 'extra fingers', 'missing fingers', 'extra arms', 'extra legs', 'fused fingers', 'too many fingers', 'long neck', 'long body', 'elongated', 'stretched', 'duplicate', 'multiple', 'conjoined', 'merged',\n  // é£æ ¼é—®é¢˜\n  'amateur', 'sketch', 'draft', 'unfinished', 'rough', 'simple', 'basic', 'plain', 'boring', 'dull', 'monochrome', 'grayscale', 'black and white', 'sepia',\n  // å†…å®¹é—®é¢˜\n  'nsfw', 'nude', 'naked', 'explicit', 'sexual', 'violence', 'blood', 'gore', 'disturbing', 'scary', 'dark', 'horror', 'nightmare', 'creepy', 'evil',\n  // ä¸­æ–‡è´Ÿå‘è¯\n  'æœ€å·®è´¨é‡', 'ç³Ÿç³•è´¨é‡', 'ä½è´¨é‡', 'å·®è´¨é‡', 'ç³Ÿç³•è§£å‰–', 'å˜å½¢', 'ç•¸å½¢', 'ä¸‘é™‹', 'æ¨¡ç³Š', 'ä½åˆ†è¾¨ç‡', 'åƒç´ åŒ–', 'å™ªç‚¹', 'ä¼ªå½±', 'æ°´å°', 'ç­¾å', 'æ–‡å­—', 'æ ‡å¿—', 'ç”¨æˆ·å', 'å¤šä½™çš„', 'ç¼ºå¤±çš„', 'èåˆçš„', 'é‡å¤çš„', 'ä¸šä½™', 'è‰å›¾', 'æœªå®Œæˆ', 'ç²—ç³™', 'ç®€å•', 'å•è‰²', 'ç°åº¦', 'é»‘ç™½', 'æš—è‰²è°ƒ'];\n\n  // æ£€æŸ¥æ˜¯å¦åŒ…å«è´Ÿå‘å…³é”®è¯\n  const hasNegativeKeywords = negativeKeywords.some(keyword => lowerText.includes(keyword.toLowerCase()));\n\n  // æ£€æŸ¥è´Ÿå‘æç¤ºè¯çš„æ¯”ä¾‹\n  const negativeWordCount = negativeKeywords.filter(keyword => lowerText.includes(keyword.toLowerCase())).length;\n  const totalWords = text.split(/\\s+/).length;\n  const negativeRatio = negativeWordCount / totalWords;\n\n  // å¦‚æœè´Ÿå‘è¯æ±‡æ¯”ä¾‹è¶…è¿‡30%ï¼Œå¾ˆå¯èƒ½æ˜¯è´Ÿå‘æç¤ºè¯\n  const isHighNegativeRatio = negativeRatio > 0.3;\n\n  // æ£€æŸ¥æ˜¯å¦ä»¥è´Ÿå‘è¯å¼€å¤´\n  const startsWithNegative = negativeKeywords.some(keyword => lowerText.startsWith(keyword.toLowerCase()));\n  console.log(`ğŸ” è´Ÿå‘æ£€æµ‹: å…³é”®è¯=${hasNegativeKeywords}, æ¯”ä¾‹=${negativeRatio.toFixed(2)}, å¼€å¤´=${startsWithNegative}`);\n  return hasNegativeKeywords || isHighNegativeRatio || startsWithNegative;\n}\n\n// è§£æNovelAIæ•°æ®\nfunction parseNovelAI(text) {\n  const result = {\n    positive: '',\n    negative: '',\n    parameters: {}\n  };\n  try {\n    const data = JSON.parse(text);\n    result.positive = data.prompt || '';\n    result.negative = data.uc || '';\n    ['steps', 'scale', 'seed', 'sampler', 'width', 'height'].forEach(key => {\n      if (data[key] !== undefined) {\n        result.parameters[key] = data[key];\n      }\n    });\n  } catch (error) {\n    console.warn('NovelAIè§£æå¤±è´¥:', error);\n  }\n  return result;\n}\n\n// EXIFæ•°æ®æå–\nasync function extractFromEXIF(file) {\n  try {\n    // åŠ¨æ€å¯¼å…¥exifr\n    const exifr = await import('exifr');\n    const exifData = await exifr.parse(file, {\n      userComment: true,\n      imageDescription: true,\n      software: true\n    });\n    if (!exifData) return null;\n    return {\n      type: 'EXIF',\n      confidence: 'medium',\n      data: {\n        software: exifData.Software,\n        description: exifData.ImageDescription,\n        userComment: exifData.UserComment,\n        positive: exifData.UserComment || exifData.ImageDescription || '',\n        negative: '',\n        parameters: {}\n      }\n    };\n  } catch (error) {\n    console.warn('EXIFæå–å¤±è´¥:', error);\n    return null;\n  }\n}\n\n// æ ‡å‡†åŒ–æ•°æ®\nfunction standardizeData(extractedData) {\n  const standardized = {\n    generationTool: 'Unknown',\n    positive: '',\n    negative: '',\n    parameters: {}\n  };\n\n  // ä¼˜å…ˆçº§é¡ºåº\n  const sources = ['PNG', 'EXIF'];\n  for (const source of sources) {\n    const data = extractedData[source];\n    if (!data) continue;\n    if (data.data.generationTool) {\n      standardized.generationTool = data.data.generationTool;\n    }\n    if (data.data.positive && !standardized.positive) {\n      standardized.positive = data.data.positive;\n    }\n    if (data.data.negative && !standardized.negative) {\n      standardized.negative = data.data.negative;\n    }\n    Object.assign(standardized.parameters, data.data.parameters || {});\n  }\n  return standardized;\n}\n\n// å¯¼å‡ºä¸»è¦å‡½æ•°\nexport const imageMetadataExtractor = {\n  extractMetadata\n};\nexport default imageMetadataExtractor;","map":{"version":3,"names":["extractMetadata","file","console","log","result","success","filename","name","extractedData","standardizedData","timestamp","Date","toISOString","basicInfo","size","sizeFormatted","toFixed","type","lastModified","toLocaleString","pngData","extractFromPNG","PNG","exifData","extractFromEXIF","EXIF","error","warn","standardizeData","Object","keys","length","extractionMethods","map","method","_result$extractedData","confidence","message","Promise","resolve","reject","reader","FileReader","onload","e","buffer","target","chunks","parsePNGChunks","metadata","extractMetadataFromChunks","data","onerror","readAsArrayBuffer","view","DataView","offset","signature","i","getUint8","Error","byteLength","getUint32","String","fromCharCode","Uint8Array","crc","push","textChunks","filter","chunk","includes","generationTool","positive","negative","parameters","textData","parseTextChunk","keyword","text","isAutomatic1111Format","parsed","parseAutomatic1111","assign","parseComfyUI","parseNovelAI","nullIndex","indexOf","decodeLatin1","slice","nullIndices","decodeUTF8","TextDecoder","fatal","decode","lowerText","toLowerCase","negativeIndex","substring","trim","afterNegative","lines","split","negativePrompt","parameterLines","foundParams","line","trimmed","isParameterLine","parseParameters","join","positiveLines","test","paramText","regex","match","exec","key","replace","value","numValue","parseFloat","isNaN","isFinite","JSON","parse","Array","isArray","nodes","prompts","extractFromComfyWorkflow","extractFromComfyPrompt","deepSearch","deepSearchPrompts","allTexts","searchObject","obj","path","isSystemText","forEach","item","index","entries","importantKeys","newPath","sort","a","b","positiveTexts","negativeTexts","textObj","some","t","isNegativePrompt","selectBestPrompt","systemPatterns","pattern","texts","scoredTexts","score","idealLength","lengthScore","Math","max","abs","commaCount","min","qualityWords","qualityScore","word","styleWords","styleScore","words","uniqueWords","Set","uniqueRatio","best","workflow","_workflow$nodes","positivePrompts","negativePrompts","node","title","textEncoderTypes","widgets_values","inputs","input","widget","properties","_node$title","_node$title2","_node$title3","isNegative","color","seed","steps","cfg","sampler_name","scheduler","denoise","undefined","cfg_scale","sampler","model","width","height","finalPositive","smartMergePrompts","finalNegative","uniquePrompts","longest","secondLongest","prompt","nodeId","nodeData","class_type","_nodeData$inputs","_nodeData$inputs2","_nodeData$inputs3","string","negativeKeywords","hasNegativeKeywords","negativeWordCount","totalWords","negativeRatio","isHighNegativeRatio","startsWithNegative","startsWith","uc","exifr","userComment","imageDescription","software","Software","description","ImageDescription","UserComment","standardized","sources","source","imageMetadataExtractor"],"sources":["C:/Users/wjx19/Documents/GitHub/I-Prompt/src/utils/imageMetadataExtractor.js"],"sourcesContent":["/**\n * ç®€åŒ–çš„å›¾åƒå…ƒæ•°æ®æå–å™¨\n * å‚è€ƒstable-diffusion-inspectorçš„å®ç°æ–¹å¼\n */\n\n// ä¸»è¦çš„æå–å‡½æ•°\nexport async function extractMetadata(file) {\n  console.log('ğŸš€ å¼€å§‹æå–å›¾åƒå…ƒæ•°æ®...');\n  \n  const result = {\n    success: false,\n    filename: file.name,\n    extractedData: {},\n    standardizedData: null,\n    timestamp: new Date().toISOString()\n  };\n\n  try {\n    // åŸºæœ¬æ–‡ä»¶ä¿¡æ¯\n    result.basicInfo = {\n      size: file.size,\n      sizeFormatted: `${(file.size / 1024).toFixed(1)} KB`,\n      type: file.type,\n      lastModified: new Date(file.lastModified).toLocaleString()\n    };\n\n    // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©æå–æ–¹æ³•\n    if (file.type === 'image/png') {\n      const pngData = await extractFromPNG(file);\n      if (pngData) {\n        result.extractedData.PNG = pngData;\n      }\n    }\n\n    // å°è¯•EXIFæå–\n    try {\n      const exifData = await extractFromEXIF(file);\n      if (exifData) {\n        result.extractedData.EXIF = exifData;\n      }\n    } catch (error) {\n      console.warn('EXIFæå–å¤±è´¥:', error);\n    }\n\n    // æ ‡å‡†åŒ–æ•°æ®\n    result.standardizedData = standardizeData(result.extractedData);\n    result.success = Object.keys(result.extractedData).length > 0;\n\n    // æ·»åŠ æå–æ–¹æ³•ä¿¡æ¯\n    result.extractionMethods = Object.keys(result.extractedData).map(method => ({\n      method: method,\n      confidence: result.extractedData[method]?.confidence || 'unknown'\n    }));\n\n    return result;\n    \n  } catch (error) {\n    console.error('âŒ å…ƒæ•°æ®æå–å¤±è´¥:', error);\n    result.error = error.message;\n    throw error;\n  }\n}\n\n// PNGæ–‡ä»¶è§£æ - å‚è€ƒstable-diffusion-inspectorçš„ç®€æ´å®ç°\nasync function extractFromPNG(file) {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    \n    reader.onload = (e) => {\n      try {\n        const buffer = e.target.result;\n        const chunks = parsePNGChunks(buffer);\n        const metadata = extractMetadataFromChunks(chunks);\n        \n        resolve({\n          type: 'PNG',\n          confidence: metadata.confidence || 'medium',\n          data: metadata\n        });\n      } catch (error) {\n        console.warn('PNGè§£æå¤±è´¥:', error);\n        resolve(null);\n      }\n    };\n    \n    reader.onerror = () => resolve(null);\n    reader.readAsArrayBuffer(file);\n  });\n}\n\n// ç®€åŒ–çš„PNGå—è§£æ\nfunction parsePNGChunks(buffer) {\n  const view = new DataView(buffer);\n  const chunks = [];\n  let offset = 8; // è·³è¿‡PNGç­¾å\n\n  // éªŒè¯PNGç­¾å\n  const signature = [0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A];\n  for (let i = 0; i < 8; i++) {\n    if (view.getUint8(i) !== signature[i]) {\n      throw new Error('ä¸æ˜¯æœ‰æ•ˆçš„PNGæ–‡ä»¶');\n    }\n  }\n\n  while (offset < buffer.byteLength - 8) {\n    try {\n      const length = view.getUint32(offset);\n      offset += 4;\n\n      const type = String.fromCharCode(\n        view.getUint8(offset),\n        view.getUint8(offset + 1),\n        view.getUint8(offset + 2),\n        view.getUint8(offset + 3)\n      );\n      offset += 4;\n\n      const data = new Uint8Array(buffer, offset, length);\n      offset += length;\n\n      const crc = view.getUint32(offset);\n      offset += 4;\n\n      chunks.push({ type, length, data, crc });\n\n      if (type === 'IEND') break;\n    } catch (error) {\n      console.warn('PNGå—è§£æè­¦å‘Š:', error);\n      break;\n    }\n  }\n\n  return chunks;\n}\n\n// ä»PNGå—æå–å…ƒæ•°æ®\nfunction extractMetadataFromChunks(chunks) {\n  const textChunks = chunks.filter(chunk => \n    ['tEXt', 'iTXt', 'zTXt'].includes(chunk.type)\n  );\n\n  const metadata = {\n    confidence: 'low',\n    generationTool: 'Unknown',\n    positive: '',\n    negative: '',\n    parameters: {}\n  };\n\n  for (const chunk of textChunks) {\n    const textData = parseTextChunk(chunk);\n    if (!textData.keyword || !textData.text) continue;\n\n    console.log('è§£ææ–‡æœ¬å—:', textData.keyword, 'é•¿åº¦:', textData.text.length);\n\n    // æ£€æµ‹ä¸åŒæ ¼å¼\n    if (textData.keyword === 'parameters' && isAutomatic1111Format(textData.text)) {\n      const parsed = parseAutomatic1111(textData.text);\n      Object.assign(metadata, parsed);\n      metadata.generationTool = 'AUTOMATIC1111';\n      metadata.confidence = 'high';\n    } else if (['workflow', 'prompt'].includes(textData.keyword)) {\n      try {\n        const parsed = parseComfyUI(textData.text);\n        Object.assign(metadata, parsed);\n        metadata.generationTool = 'ComfyUI';\n        metadata.confidence = 'high';\n      } catch (error) {\n        console.warn('ComfyUIè§£æå¤±è´¥:', error);\n      }\n    } else if (['Description', 'Comment'].includes(textData.keyword)) {\n      try {\n        const parsed = parseNovelAI(textData.text);\n        Object.assign(metadata, parsed);\n        metadata.generationTool = 'NovelAI';\n        metadata.confidence = 'high';\n      } catch (error) {\n        console.warn('NovelAIè§£æå¤±è´¥:', error);\n      }\n    }\n  }\n\n  return metadata;\n}\n\n// è§£ææ–‡æœ¬å—\nfunction parseTextChunk(chunk) {\n  try {\n    const data = chunk.data;\n    \n    if (chunk.type === 'tEXt') {\n      const nullIndex = data.indexOf(0);\n      if (nullIndex === -1) return {};\n\n      const keyword = decodeLatin1(data.slice(0, nullIndex));\n      const text = decodeLatin1(data.slice(nullIndex + 1));\n      return { keyword, text };\n    }\n    \n    if (chunk.type === 'iTXt') {\n      const nullIndices = [];\n      for (let i = 0; i < data.length; i++) {\n        if (data[i] === 0) {\n          nullIndices.push(i);\n          if (nullIndices.length >= 4) break;\n        }\n      }\n\n      if (nullIndices.length < 4) return {};\n\n      const keyword = decodeUTF8(data.slice(0, nullIndices[0]));\n      const text = decodeUTF8(data.slice(nullIndices[3] + 1));\n      return { keyword, text };\n    }\n    \n    return {};\n  } catch (error) {\n    console.warn('æ–‡æœ¬å—è§£æå¤±è´¥:', error);\n    return {};\n  }\n}\n\n// å®‰å…¨çš„å­—ç¬¦è§£ç \nfunction decodeLatin1(data) {\n  let result = '';\n  for (let i = 0; i < data.length; i++) {\n    result += String.fromCharCode(data[i]);\n  }\n  return result;\n}\n\nfunction decodeUTF8(data) {\n  try {\n    return new TextDecoder('utf-8', { fatal: false }).decode(data);\n  } catch (error) {\n    return decodeLatin1(data);\n  }\n}\n\n// æ£€æµ‹AUTOMATIC1111æ ¼å¼\nfunction isAutomatic1111Format(text) {\n  const lowerText = text.toLowerCase();\n  return lowerText.includes('steps:') || \n         lowerText.includes('cfg scale:') || \n         lowerText.includes('sampler:') || \n         lowerText.includes('negative prompt:');\n}\n\n// è§£æAUTOMATIC1111æ•°æ®\nfunction parseAutomatic1111(text) {\n  const result = {\n    positive: '',\n    negative: '',\n    parameters: {}\n  };\n\n  try {\n    const negativeIndex = text.indexOf('Negative prompt:');\n    \n    if (negativeIndex !== -1) {\n      result.positive = text.substring(0, negativeIndex).trim();\n      \n      const afterNegative = text.substring(negativeIndex + 16);\n      const lines = afterNegative.split('\\n');\n      \n      let negativePrompt = '';\n      let parameterLines = [];\n      let foundParams = false;\n      \n      for (const line of lines) {\n        const trimmed = line.trim();\n        if (isParameterLine(trimmed)) {\n          foundParams = true;\n          parameterLines.push(trimmed);\n        } else if (!foundParams && trimmed) {\n          negativePrompt += (negativePrompt ? '\\n' : '') + trimmed;\n        } else if (foundParams) {\n          parameterLines.push(trimmed);\n        }\n      }\n      \n      result.negative = negativePrompt.trim();\n      \n      if (parameterLines.length > 0) {\n        result.parameters = parseParameters(parameterLines.join(', '));\n      }\n    } else {\n      // æ²¡æœ‰è´Ÿå‘æç¤ºè¯çš„æƒ…å†µ\n      const lines = text.split('\\n');\n      let positiveLines = [];\n      let parameterLines = [];\n      let foundParams = false;\n      \n      for (const line of lines) {\n        const trimmed = line.trim();\n        if (isParameterLine(trimmed)) {\n          foundParams = true;\n          parameterLines.push(trimmed);\n        } else if (!foundParams && trimmed) {\n          positiveLines.push(trimmed);\n        } else if (foundParams) {\n          parameterLines.push(trimmed);\n        }\n      }\n      \n      result.positive = positiveLines.join(' ').trim();\n      \n      if (parameterLines.length > 0) {\n        result.parameters = parseParameters(parameterLines.join(', '));\n      }\n    }\n  } catch (error) {\n    console.warn('AUTOMATIC1111è§£æè­¦å‘Š:', error);\n    result.positive = text;\n  }\n\n  return result;\n}\n\n// æ£€æµ‹å‚æ•°è¡Œ\nfunction isParameterLine(line) {\n  return /\\b(Steps|Sampler|CFG scale|Seed|Size|Model):/i.test(line);\n}\n\n// è§£æå‚æ•°\nfunction parseParameters(paramText) {\n  const parameters = {};\n  const regex = /(\\w+(?:\\s+\\w+)*)\\s*:\\s*([^,]+?)(?=,\\s*\\w+\\s*:|$)/g;\n  let match;\n\n  while ((match = regex.exec(paramText)) !== null) {\n    const key = match[1].trim().toLowerCase().replace(/\\s+/g, '');\n    const value = match[2].trim();\n    \n    const numValue = parseFloat(value);\n    parameters[key] = !isNaN(numValue) && isFinite(numValue) ? numValue : value;\n  }\n\n  return parameters;\n}\n\n// è§£æComfyUIæ•°æ®\nfunction parseComfyUI(text) {\n  const result = {\n    positive: '',\n    negative: '',\n    parameters: {}\n  };\n\n  try {\n    const data = JSON.parse(text);\n    \n    if (Array.isArray(data?.nodes)) {\n      // å·¥ä½œæµæ ¼å¼\n      console.log('ğŸ“‹ æ£€æµ‹åˆ°ComfyUIå·¥ä½œæµæ ¼å¼');\n      const prompts = extractFromComfyWorkflow(data);\n      result.positive = prompts.positive;\n      result.negative = prompts.negative;\n      Object.assign(result.parameters, prompts.parameters);\n    } else if (typeof data === 'object') {\n      // æç¤ºæ ¼å¼\n      console.log('ğŸ“‹ æ£€æµ‹åˆ°ComfyUIæç¤ºæ ¼å¼');\n      const prompts = extractFromComfyPrompt(data);\n      result.positive = prompts.positive;\n      result.negative = prompts.negative;\n      Object.assign(result.parameters, prompts.parameters);\n    }\n    \n    // å¦‚æœæ²¡æœ‰æå–åˆ°æç¤ºè¯ï¼Œå°è¯•æ·±åº¦æœç´¢\n    if (!result.positive && !result.negative) {\n      console.log('ğŸ” å¼€å§‹æ·±åº¦æœç´¢æç¤ºè¯...');\n      const deepSearch = deepSearchPrompts(data);\n      result.positive = deepSearch.positive;\n      result.negative = deepSearch.negative;\n      Object.assign(result.parameters, deepSearch.parameters);\n    }\n    \n  } catch (error) {\n    console.warn('ComfyUIè§£æå¤±è´¥:', error);\n  }\n\n  return result;\n}\n\n// æ·±åº¦æœç´¢æç¤ºè¯ï¼ˆç”¨äºå¤æ‚å·¥ä½œæµï¼‰\nfunction deepSearchPrompts(data) {\n  const result = {\n    positive: '',\n    negative: '',\n    parameters: {}\n  };\n  \n  const allTexts = [];\n  \n  // é€’å½’æœç´¢æ‰€æœ‰å¯èƒ½åŒ…å«æ–‡æœ¬çš„å­—æ®µ\n  function searchObject(obj, path = '') {\n    if (typeof obj === 'string' && obj.trim().length > 10) {\n      // è¿‡æ»¤æ‰æ˜æ˜¾ä¸æ˜¯æç¤ºè¯çš„æ–‡æœ¬\n      if (!isSystemText(obj)) {\n        allTexts.push({\n          text: obj.trim(),\n          path: path,\n          length: obj.trim().length\n        });\n        console.log(`ğŸ” å‘ç°æ–‡æœ¬ (${path}): ${obj.substring(0, 50)}...`);\n      }\n    } else if (Array.isArray(obj)) {\n      obj.forEach((item, index) => {\n        searchObject(item, `${path}[${index}]`);\n      });\n    } else if (typeof obj === 'object' && obj !== null) {\n      Object.entries(obj).forEach(([key, value]) => {\n        // é‡ç‚¹å…³æ³¨å¯èƒ½åŒ…å«æç¤ºè¯çš„å­—æ®µ\n        const importantKeys = ['text', 'prompt', 'string', 'content', 'value', 'input', 'output'];\n        const newPath = importantKeys.includes(key.toLowerCase()) ? `${path}.${key}*` : `${path}.${key}`;\n        searchObject(value, newPath);\n      });\n    }\n  }\n  \n  searchObject(data);\n  \n  // æŒ‰é•¿åº¦æ’åºï¼Œä¼˜å…ˆå¤„ç†è¾ƒé•¿çš„æ–‡æœ¬ï¼ˆå¯èƒ½æ˜¯æœ€ç»ˆç»“æœï¼‰\n  allTexts.sort((a, b) => b.length - a.length);\n  \n  console.log(`ğŸ¯ å…±å‘ç° ${allTexts.length} ä¸ªæ–‡æœ¬ç‰‡æ®µ`);\n  \n  // æ™ºèƒ½åˆ†ç±»æ–‡æœ¬\n  const positiveTexts = [];\n  const negativeTexts = [];\n  \n  for (const textObj of allTexts) {\n    const text = textObj.text;\n    \n    // è·³è¿‡é‡å¤çš„æ–‡æœ¬\n    if (positiveTexts.some(t => t.includes(text) || text.includes(t)) ||\n        negativeTexts.some(t => t.includes(text) || text.includes(t))) {\n      continue;\n    }\n    \n    if (isNegativePrompt(text)) {\n      negativeTexts.push(text);\n      console.log(`â– åˆ†ç±»ä¸ºè´Ÿå‘: ${text.substring(0, 30)}...`);\n    } else {\n      positiveTexts.push(text);\n      console.log(`â• åˆ†ç±»ä¸ºæ­£å‘: ${text.substring(0, 30)}...`);\n    }\n  }\n  \n  // é€‰æ‹©æœ€ä½³æ–‡æœ¬\n  result.positive = selectBestPrompt(positiveTexts);\n  result.negative = selectBestPrompt(negativeTexts);\n  \n  return result;\n}\n\n// åˆ¤æ–­æ˜¯å¦ä¸ºç³»ç»Ÿæ–‡æœ¬ï¼ˆéæç¤ºè¯ï¼‰\nfunction isSystemText(text) {\n  const systemPatterns = [\n    /^[a-f0-9]{8,}$/i,  // å“ˆå¸Œå€¼\n    /^\\d+\\.\\d+\\.\\d+/,   // ç‰ˆæœ¬å·\n    /^https?:\\/\\//,     // URL\n    /^[A-Z_]+$/,        // å…¨å¤§å†™å¸¸é‡\n    /^\\w+\\.(png|jpg|jpeg|webp|gif)$/i,  // æ–‡ä»¶å\n    /^(true|false|null|undefined)$/i,   // å¸ƒå°”å€¼\n    /^\\d+x\\d+$/,        // å°ºå¯¸\n    /^#[a-f0-9]{6}$/i,  // é¢œè‰²ä»£ç \n  ];\n  \n  return systemPatterns.some(pattern => pattern.test(text.trim()));\n}\n\n// é€‰æ‹©æœ€ä½³æç¤ºè¯\nfunction selectBestPrompt(texts) {\n  if (texts.length === 0) return '';\n  if (texts.length === 1) return texts[0];\n  \n  // è¯„åˆ†ç³»ç»Ÿ\n  const scoredTexts = texts.map(text => {\n    let score = 0;\n    \n    // é•¿åº¦åŠ åˆ†ï¼ˆä½†ä¸æ˜¯è¶Šé•¿è¶Šå¥½ï¼‰\n    const idealLength = 200;\n    const lengthScore = Math.max(0, 1 - Math.abs(text.length - idealLength) / idealLength);\n    score += lengthScore * 0.3;\n    \n    // é€—å·æ•°é‡åŠ åˆ†ï¼ˆè¡¨ç¤ºæ ‡ç­¾ä¸°å¯Œåº¦ï¼‰\n    const commaCount = (text.match(/,/g) || []).length;\n    score += Math.min(commaCount / 10, 1) * 0.2;\n    \n    // åŒ…å«è´¨é‡è¯åŠ åˆ†\n    const qualityWords = ['masterpiece', 'best quality', 'high quality', 'detailed', 'professional'];\n    const qualityScore = qualityWords.filter(word => \n      text.toLowerCase().includes(word)\n    ).length / qualityWords.length;\n    score += qualityScore * 0.2;\n    \n    // åŒ…å«è‰ºæœ¯é£æ ¼è¯åŠ åˆ†\n    const styleWords = ['anime', 'realistic', 'painting', 'illustration', 'digital art', 'concept art'];\n    const styleScore = styleWords.filter(word => \n      text.toLowerCase().includes(word)\n    ).length / styleWords.length;\n    score += styleScore * 0.1;\n    \n    // é¿å…é‡å¤è¯æ±‡\n    const words = text.toLowerCase().split(/\\s+/);\n    const uniqueWords = new Set(words);\n    const uniqueRatio = uniqueWords.size / words.length;\n    score += uniqueRatio * 0.2;\n    \n    return { text, score };\n  });\n  \n  // é€‰æ‹©å¾—åˆ†æœ€é«˜çš„\n  scoredTexts.sort((a, b) => b.score - a.score);\n  const best = scoredTexts[0];\n  \n  console.log(`ğŸ† é€‰æ‹©æœ€ä½³æç¤ºè¯ (å¾—åˆ†: ${best.score.toFixed(2)}): ${best.text.substring(0, 50)}...`);\n  \n  return best.text;\n}\n\n// ä»ComfyUIå·¥ä½œæµæå–\nfunction extractFromComfyWorkflow(workflow) {\n  const positivePrompts = [];\n  const negativePrompts = [];\n  const parameters = {};\n\n  console.log('ğŸ” åˆ†æComfyUIå·¥ä½œæµï¼ŒèŠ‚ç‚¹æ•°é‡:', workflow.nodes?.length || 0);\n\n  for (const node of workflow.nodes || []) {\n    console.log(`ğŸ“ æ£€æŸ¥èŠ‚ç‚¹: ${node.type} (${node.title || 'untitled'})`);\n    \n    // æ‰©å±•æ”¯æŒçš„æ–‡æœ¬ç¼–ç èŠ‚ç‚¹ç±»å‹\n    const textEncoderTypes = [\n      'CLIPTextEncode', \n      'CLIPTextEncodeSDXL',\n      'BNK_CLIPTextEncoder',  // BNKç³»åˆ—èŠ‚ç‚¹\n      'WeiLin-ComfyUI-prompt-all-in-one',  // WeiLinæ’ä»¶\n      'TIPO',  // TIPOèŠ‚ç‚¹\n      'PromptWithStyle',  // æ ·å¼æç¤ºè¯èŠ‚ç‚¹\n      'StringFunction',  // å­—ç¬¦ä¸²å¤„ç†èŠ‚ç‚¹\n      'Text',  // é€šç”¨æ–‡æœ¬èŠ‚ç‚¹\n      'TextInput',  // æ–‡æœ¬è¾“å…¥èŠ‚ç‚¹\n      'PromptBuilder',  // æç¤ºè¯æ„å»ºå™¨\n      'AdvancedCLIPTextEncode',  // é«˜çº§CLIPç¼–ç å™¨\n      'CLIPTextEncodeFlux',  // Fluxæ¨¡å‹ç¼–ç å™¨\n      'ShowText',  // æ˜¾ç¤ºæ–‡æœ¬èŠ‚ç‚¹\n      'StringConstant',  // å­—ç¬¦ä¸²å¸¸é‡\n      'MultilineStringLiteral'  // å¤šè¡Œå­—ç¬¦ä¸²\n    ];\n\n    if (textEncoderTypes.includes(node.type)) {\n      console.log(`âœ… æ‰¾åˆ°æ–‡æœ¬ç¼–ç èŠ‚ç‚¹: ${node.type}`);\n      \n      // å°è¯•å¤šç§æ–¹å¼è·å–æ–‡æœ¬å†…å®¹\n      let text = null;\n      \n      // æ–¹å¼1: widgets_valuesæ•°ç»„\n      if (node.widgets_values && Array.isArray(node.widgets_values)) {\n        for (const value of node.widgets_values) {\n          if (typeof value === 'string' && value.trim().length > 0) {\n            text = value.trim();\n            console.log(`ğŸ“„ ä»widgets_valuesè·å–æ–‡æœ¬: ${text.substring(0, 50)}...`);\n            break;\n          }\n        }\n      }\n      \n      // æ–¹å¼2: ç›´æ¥çš„textå±æ€§\n      if (!text && node.text && typeof node.text === 'string') {\n        text = node.text.trim();\n        console.log(`ğŸ“„ ä»textå±æ€§è·å–æ–‡æœ¬: ${text.substring(0, 50)}...`);\n      }\n      \n      // æ–¹å¼3: inputsä¸­çš„text\n      if (!text && node.inputs) {\n        for (const input of node.inputs) {\n          if (input.name === 'text' && input.widget && input.widget.value) {\n            text = input.widget.value.trim();\n            console.log(`ğŸ“„ ä»inputsè·å–æ–‡æœ¬: ${text.substring(0, 50)}...`);\n            break;\n          }\n        }\n      }\n      \n      // æ–¹å¼4: propertiesä¸­æŸ¥æ‰¾\n      if (!text && node.properties) {\n        if (node.properties.text) {\n          text = node.properties.text.trim();\n          console.log(`ğŸ“„ ä»propertiesè·å–æ–‡æœ¬: ${text.substring(0, 50)}...`);\n        }\n      }\n      \n      if (text && text.length > 0) {\n        // æ™ºèƒ½åˆ¤æ–­æ˜¯å¦ä¸ºè´Ÿå‘æç¤ºè¯\n        const isNegative = isNegativePrompt(text) || \n                          node.title?.toLowerCase().includes('negative') ||\n                          node.title?.toLowerCase().includes('è´Ÿå‘') ||\n                          node.title?.toLowerCase().includes('åå‘') ||\n                          (node.color && (node.color === '#ff6b6b' || node.color === '#e74c3c')); // çº¢è‰²é€šå¸¸è¡¨ç¤ºè´Ÿå‘\n        \n        if (isNegative) {\n          negativePrompts.push(text);\n          console.log(`â– è¯†åˆ«ä¸ºè´Ÿå‘æç¤ºè¯: ${text.substring(0, 30)}...`);\n        } else {\n          positivePrompts.push(text);\n          console.log(`â• è¯†åˆ«ä¸ºæ­£å‘æç¤ºè¯: ${text.substring(0, 30)}...`);\n        }\n      }\n    }\n    \n    // æå–é‡‡æ ·å™¨å‚æ•°\n    if (['KSampler', 'KSamplerAdvanced', 'SamplerCustom'].includes(node.type)) {\n      if (node.widgets_values) {\n        const [seed, steps, cfg, sampler_name, scheduler, denoise] = node.widgets_values;\n        if (seed !== undefined) parameters.seed = seed;\n        if (steps !== undefined) parameters.steps = steps;\n        if (cfg !== undefined) parameters.cfg_scale = cfg;\n        if (sampler_name !== undefined) parameters.sampler = sampler_name;\n        if (scheduler !== undefined) parameters.scheduler = scheduler;\n        if (denoise !== undefined) parameters.denoise = denoise;\n        console.log(`âš™ï¸ æå–é‡‡æ ·å™¨å‚æ•°: steps=${steps}, cfg=${cfg}, sampler=${sampler_name}`);\n      }\n    }\n    \n    // æå–æ¨¡å‹ä¿¡æ¯\n    if (['CheckpointLoaderSimple', 'CheckpointLoader'].includes(node.type)) {\n      if (node.widgets_values && node.widgets_values[0]) {\n        parameters.model = node.widgets_values[0];\n        console.log(`ğŸ¯ æå–æ¨¡å‹: ${parameters.model}`);\n      }\n    }\n    \n    // æå–å›¾åƒå°ºå¯¸\n    if (['EmptyLatentImage', 'LatentUpscale'].includes(node.type)) {\n      if (node.widgets_values) {\n        const [width, height] = node.widgets_values;\n        if (width !== undefined) parameters.width = width;\n        if (height !== undefined) parameters.height = height;\n        console.log(`ğŸ“ æå–å°ºå¯¸: ${width}x${height}`);\n      }\n    }\n  }\n\n  // æ™ºèƒ½åˆå¹¶æç¤ºè¯\n  const finalPositive = smartMergePrompts(positivePrompts);\n  const finalNegative = smartMergePrompts(negativePrompts);\n  \n  console.log(`ğŸ¯ æœ€ç»ˆç»“æœ: æ­£å‘æç¤ºè¯${finalPositive.length}å­—ç¬¦, è´Ÿå‘æç¤ºè¯${finalNegative.length}å­—ç¬¦`);\n\n  return {\n    positive: finalPositive,\n    negative: finalNegative,\n    parameters\n  };\n}\n\n// æ™ºèƒ½åˆå¹¶æç¤ºè¯\nfunction smartMergePrompts(prompts) {\n  if (prompts.length === 0) return '';\n  if (prompts.length === 1) return prompts[0];\n  \n  // å»é‡å¹¶æŒ‰é•¿åº¦æ’åºï¼Œä¼˜å…ˆé€‰æ‹©æ›´å®Œæ•´çš„æç¤ºè¯\n  const uniquePrompts = [...new Set(prompts)];\n  uniquePrompts.sort((a, b) => b.length - a.length);\n  \n  // å¦‚æœæœ€é•¿çš„æç¤ºè¯æ˜æ˜¾æ¯”å…¶ä»–çš„é•¿å¾ˆå¤šï¼Œå¯èƒ½æ˜¯æœ€ç»ˆåˆæˆçš„ç»“æœ\n  const longest = uniquePrompts[0];\n  const secondLongest = uniquePrompts[1] || '';\n  \n  if (longest.length > secondLongest.length * 2) {\n    console.log(`ğŸ¯ é€‰æ‹©æœ€é•¿æç¤ºè¯ä½œä¸ºæœ€ç»ˆç»“æœ: ${longest.length} vs ${secondLongest.length}`);\n    return longest;\n  }\n  \n  // å¦åˆ™åˆå¹¶æ‰€æœ‰å”¯ä¸€çš„æç¤ºè¯\n  return uniquePrompts.join(', ');\n}\n\n// ä»ComfyUIæç¤ºæå–\nfunction extractFromComfyPrompt(prompt) {\n  const positivePrompts = [];\n  const negativePrompts = [];\n  const parameters = {};\n\n  console.log('ğŸ” åˆ†æComfyUIæç¤ºæ ¼å¼ï¼ŒèŠ‚ç‚¹æ•°é‡:', Object.keys(prompt).length);\n\n  for (const [nodeId, nodeData] of Object.entries(prompt)) {\n    console.log(`ğŸ“ æ£€æŸ¥èŠ‚ç‚¹ ${nodeId}: ${nodeData.class_type}`);\n    \n    // æ‰©å±•æ”¯æŒçš„èŠ‚ç‚¹ç±»å‹\n    const textEncoderTypes = [\n      'CLIPTextEncode', \n      'CLIPTextEncodeSDXL',\n      'BNK_CLIPTextEncoder',\n      'WeiLin-ComfyUI-prompt-all-in-one',\n      'TIPO',\n      'PromptWithStyle',\n      'StringFunction',\n      'Text',\n      'TextInput',\n      'PromptBuilder',\n      'AdvancedCLIPTextEncode',\n      'CLIPTextEncodeFlux',\n      'ShowText',\n      'StringConstant',\n      'MultilineStringLiteral'\n    ];\n    \n    if (textEncoderTypes.includes(nodeData.class_type)) {\n      console.log(`âœ… æ‰¾åˆ°æ–‡æœ¬ç¼–ç èŠ‚ç‚¹: ${nodeData.class_type}`);\n      \n      // å°è¯•å¤šç§æ–¹å¼è·å–æ–‡æœ¬\n      let text = null;\n      \n      if (nodeData.inputs?.text && typeof nodeData.inputs.text === 'string') {\n        text = nodeData.inputs.text.trim();\n        console.log(`ğŸ“„ ä»inputs.textè·å–: ${text.substring(0, 50)}...`);\n      } else if (nodeData.inputs?.prompt && typeof nodeData.inputs.prompt === 'string') {\n        text = nodeData.inputs.prompt.trim();\n        console.log(`ğŸ“„ ä»inputs.promptè·å–: ${text.substring(0, 50)}...`);\n      } else if (nodeData.inputs?.string && typeof nodeData.inputs.string === 'string') {\n        text = nodeData.inputs.string.trim();\n        console.log(`ğŸ“„ ä»inputs.stringè·å–: ${text.substring(0, 50)}...`);\n      }\n      \n      if (text && text.length > 0) {\n        if (isNegativePrompt(text)) {\n          negativePrompts.push(text);\n          console.log(`â– è¯†åˆ«ä¸ºè´Ÿå‘æç¤ºè¯`);\n        } else {\n          positivePrompts.push(text);\n          console.log(`â• è¯†åˆ«ä¸ºæ­£å‘æç¤ºè¯`);\n        }\n      }\n    }\n    \n    // æå–å…¶ä»–å‚æ•°...\n    if (['KSampler', 'KSamplerAdvanced', 'SamplerCustom'].includes(nodeData.class_type)) {\n      const inputs = nodeData.inputs;\n      if (inputs.seed !== undefined) parameters.seed = inputs.seed;\n      if (inputs.steps !== undefined) parameters.steps = inputs.steps;\n      if (inputs.cfg !== undefined) parameters.cfg_scale = inputs.cfg;\n      if (inputs.sampler_name !== undefined) parameters.sampler = inputs.sampler_name;\n      if (inputs.scheduler !== undefined) parameters.scheduler = inputs.scheduler;\n      if (inputs.denoise !== undefined) parameters.denoise = inputs.denoise;\n    }\n  }\n\n  const finalPositive = smartMergePrompts(positivePrompts);\n  const finalNegative = smartMergePrompts(negativePrompts);\n  \n  console.log(`ğŸ¯ æœ€ç»ˆç»“æœ: æ­£å‘æç¤ºè¯${finalPositive.length}å­—ç¬¦, è´Ÿå‘æç¤ºè¯${finalNegative.length}å­—ç¬¦`);\n\n  return {\n    positive: finalPositive,\n    negative: finalNegative,\n    parameters\n  };\n}\n\n// æ£€æµ‹è´Ÿå‘æç¤ºè¯\nfunction isNegativePrompt(text) {\n  const lowerText = text.toLowerCase();\n  \n  // æ‰©å±•è´Ÿå‘å…³é”®è¯åˆ—è¡¨\n  const negativeKeywords = [\n    // è´¨é‡ç›¸å…³\n    'worst quality', 'bad quality', 'low quality', 'poor quality',\n    'bad anatomy', 'bad proportions', 'bad hands', 'bad fingers',\n    'ugly', 'deformed', 'disfigured', 'mutated', 'malformed',\n    'blurry', 'blur', 'out of focus', 'unfocused', 'soft focus',\n    'lowres', 'low resolution', 'pixelated', 'jpeg artifacts',\n    \n    // æŠ€æœ¯é—®é¢˜\n    'error', 'glitch', 'artifact', 'noise', 'grain', 'distorted',\n    'cropped', 'cut off', 'truncated', 'incomplete',\n    'watermark', 'signature', 'text', 'logo', 'username',\n    'border', 'frame', 'black bars', 'letterbox',\n    \n    // è§£å‰–é—®é¢˜\n    'extra limbs', 'missing limbs', 'extra fingers', 'missing fingers',\n    'extra arms', 'extra legs', 'fused fingers', 'too many fingers',\n    'long neck', 'long body', 'elongated', 'stretched',\n    'duplicate', 'multiple', 'conjoined', 'merged',\n    \n    // é£æ ¼é—®é¢˜\n    'amateur', 'sketch', 'draft', 'unfinished', 'rough',\n    'simple', 'basic', 'plain', 'boring', 'dull',\n    'monochrome', 'grayscale', 'black and white', 'sepia',\n    \n    // å†…å®¹é—®é¢˜\n    'nsfw', 'nude', 'naked', 'explicit', 'sexual',\n    'violence', 'blood', 'gore', 'disturbing', 'scary',\n    'dark', 'horror', 'nightmare', 'creepy', 'evil',\n    \n    // ä¸­æ–‡è´Ÿå‘è¯\n    'æœ€å·®è´¨é‡', 'ç³Ÿç³•è´¨é‡', 'ä½è´¨é‡', 'å·®è´¨é‡',\n    'ç³Ÿç³•è§£å‰–', 'å˜å½¢', 'ç•¸å½¢', 'ä¸‘é™‹', 'æ¨¡ç³Š',\n    'ä½åˆ†è¾¨ç‡', 'åƒç´ åŒ–', 'å™ªç‚¹', 'ä¼ªå½±',\n    'æ°´å°', 'ç­¾å', 'æ–‡å­—', 'æ ‡å¿—', 'ç”¨æˆ·å',\n    'å¤šä½™çš„', 'ç¼ºå¤±çš„', 'èåˆçš„', 'é‡å¤çš„',\n    'ä¸šä½™', 'è‰å›¾', 'æœªå®Œæˆ', 'ç²—ç³™', 'ç®€å•',\n    'å•è‰²', 'ç°åº¦', 'é»‘ç™½', 'æš—è‰²è°ƒ'\n  ];\n  \n  // æ£€æŸ¥æ˜¯å¦åŒ…å«è´Ÿå‘å…³é”®è¯\n  const hasNegativeKeywords = negativeKeywords.some(keyword => \n    lowerText.includes(keyword.toLowerCase())\n  );\n  \n  // æ£€æŸ¥è´Ÿå‘æç¤ºè¯çš„æ¯”ä¾‹\n  const negativeWordCount = negativeKeywords.filter(keyword => \n    lowerText.includes(keyword.toLowerCase())\n  ).length;\n  \n  const totalWords = text.split(/\\s+/).length;\n  const negativeRatio = negativeWordCount / totalWords;\n  \n  // å¦‚æœè´Ÿå‘è¯æ±‡æ¯”ä¾‹è¶…è¿‡30%ï¼Œå¾ˆå¯èƒ½æ˜¯è´Ÿå‘æç¤ºè¯\n  const isHighNegativeRatio = negativeRatio > 0.3;\n  \n  // æ£€æŸ¥æ˜¯å¦ä»¥è´Ÿå‘è¯å¼€å¤´\n  const startsWithNegative = negativeKeywords.some(keyword => \n    lowerText.startsWith(keyword.toLowerCase())\n  );\n  \n  console.log(`ğŸ” è´Ÿå‘æ£€æµ‹: å…³é”®è¯=${hasNegativeKeywords}, æ¯”ä¾‹=${negativeRatio.toFixed(2)}, å¼€å¤´=${startsWithNegative}`);\n  \n  return hasNegativeKeywords || isHighNegativeRatio || startsWithNegative;\n}\n\n// è§£æNovelAIæ•°æ®\nfunction parseNovelAI(text) {\n  const result = {\n    positive: '',\n    negative: '',\n    parameters: {}\n  };\n\n  try {\n    const data = JSON.parse(text);\n    result.positive = data.prompt || '';\n    result.negative = data.uc || '';\n    \n    ['steps', 'scale', 'seed', 'sampler', 'width', 'height'].forEach(key => {\n      if (data[key] !== undefined) {\n        result.parameters[key] = data[key];\n      }\n    });\n  } catch (error) {\n    console.warn('NovelAIè§£æå¤±è´¥:', error);\n  }\n\n  return result;\n}\n\n// EXIFæ•°æ®æå–\nasync function extractFromEXIF(file) {\n  try {\n    // åŠ¨æ€å¯¼å…¥exifr\n    const exifr = await import('exifr');\n    \n    const exifData = await exifr.parse(file, {\n      userComment: true,\n      imageDescription: true,\n      software: true\n    });\n\n    if (!exifData) return null;\n\n    return {\n      type: 'EXIF',\n      confidence: 'medium',\n      data: {\n        software: exifData.Software,\n        description: exifData.ImageDescription,\n        userComment: exifData.UserComment,\n        positive: exifData.UserComment || exifData.ImageDescription || '',\n        negative: '',\n        parameters: {}\n      }\n    };\n  } catch (error) {\n    console.warn('EXIFæå–å¤±è´¥:', error);\n    return null;\n  }\n}\n\n// æ ‡å‡†åŒ–æ•°æ®\nfunction standardizeData(extractedData) {\n  const standardized = {\n    generationTool: 'Unknown',\n    positive: '',\n    negative: '',\n    parameters: {}\n  };\n\n  // ä¼˜å…ˆçº§é¡ºåº\n  const sources = ['PNG', 'EXIF'];\n  \n  for (const source of sources) {\n    const data = extractedData[source];\n    if (!data) continue;\n\n    if (data.data.generationTool) {\n      standardized.generationTool = data.data.generationTool;\n    }\n\n    if (data.data.positive && !standardized.positive) {\n      standardized.positive = data.data.positive;\n    }\n\n    if (data.data.negative && !standardized.negative) {\n      standardized.negative = data.data.negative;\n    }\n\n    Object.assign(standardized.parameters, data.data.parameters || {});\n  }\n\n  return standardized;\n}\n\n// å¯¼å‡ºä¸»è¦å‡½æ•°\nexport const imageMetadataExtractor = {\n  extractMetadata\n};\n\nexport default imageMetadataExtractor; "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}